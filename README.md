# Gadgetbridge Health API

## Описание

Этот проект — асинхронный REST API-сервис на FastAPI для сбора, агрегирования и анализа данных о здоровье (шаги, сон, вес) из базы данных Gadgetbridge. Сервис предназначен для интеграции с системами автоматизации (например, n8n) и предоставляет удобные эндпоинты для получения агрегированных данных по дням.
В коде реализованы только несколько репозиториев под Xiaomi mi band 8 и Mi Scale. 

## Основные возможности
- Получение агрегированных данных по активности, сну и весу за выбранную дату
- Проверка доступности сервиса и базы данных (healthcheck)
- Защита API с помощью API-ключа
- Rate limiting (ограничение количества запросов)
- Гибкая настройка через .env
- Поддержка асинхронных запросов к SQLite
- Подробное логирование

## Структура проекта
- `main.py` — точка входа, настройка FastAPI, логирование, CORS, healthcheck
- `routers/summary.py` — основной роутер с эндпоинтом `/summary/daily`
- `repositories/` — асинхронные репозитории для работы с таблицами шагов, сна и веса
- `services/aggregation.py` — агрегирует данные из репозиториев
- `core/config.py` — конфигурация и чтение переменных из .env
- `db/session.py` — асинхронный менеджер соединения с SQLite
- `testdata/Gadgetbridge.db` — пример базы данных (не коммитить в публичный репозиторий)

## Быстрый старт

1. **Клонируйте репозиторий и перейдите в папку проекта:**
   ```sh
   git clone <repo_url>
   cd <project_folder>
   ```

2. **Создайте и активируйте виртуальное окружение:**
   ```sh
   python3 -m venv .venv
   source .venv/bin/activate
   ```

3. **Установите зависимости:**
   ```sh
   pip install -r requirements.txt
   ```

4. **Настройте переменные окружения в `.env`:**
   ```ini
   DB_PATH=/путь/к/вашей/Gadgetbridge.db
   API_KEY=ваш_секретный_ключ
   MIN_MY_WEIGHT=80
   MAX_MY_WEIGHT=150
   RATE_LIMIT=60
   LOG_LEVEL=INFO
   ```

5. **Запустите сервер:**
   ```sh
   uvicorn main:app --reload
   ```

6. **Откройте документацию Swagger:**
   [http://127.0.0.1:8000/docs](http://127.0.0.1:8000/docs)

## Примеры запросов

### Получить агрегированные данные за день
```
GET /summary/daily?day=2024-05-18
Header: x-api-key: ВАШ_КЛЮЧ
```

### Проверить работоспособность сервиса
```
GET /ping
```

### Проверить доступность БД
```
GET /health
```

## Важные замечания
- Не коммитьте файл `.env` и базу данных в публичный репозиторий!
- Все чувствительные параметры (ключи, пути, лимиты) вынесены в `.env`.
- Для production рекомендуется ограничить CORS и использовать HTTPS.

## Лицензия
MIT (или ваша лицензия)
